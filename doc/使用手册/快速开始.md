# 快速开始

## 简介
小麻雀处理器是一个包含了RTL设计、嵌入式软件设计、板级硬件设计、各种脚本的项目，接下来将一一梳理。  

## 搭建开发环境
工欲善其事，必先利其器，完善且优秀的开发环境有助于提高开发效率。小麻雀处理器封装了绝大多数的基本操作(RTL仿真、软件编译、数据转换)，使用者仅需使用鼠标点点或按几个键就能完成软硬件联合开发流程。  
**为了减少不必要的麻烦，建议使用Windows 10及以上的操作系统完成各项开发工作，Linux仅提供有限支持。**  

### 所需软件列表
小麻雀处理器想要正常使用，需要安装以下软件：  

#### 必要软件
|名称|版本|功能|
|---|---|---|
|iverilog|不低于v11|RTL仿真|
|gtkwave|不低于3.3.100|查看波形|
|Python3|不低于3.6|Py脚本解释器|
|MounRiver Studio|不低于v184|嵌入式软件开发|


#### 非必要软件
1. Makefile  
小麻雀处理器优先支持Windows下的Batchfile批处理脚本。如果使用Linux或WSL进行开发，则需要借助Makeflie脚本完成必要工作。  
Makeflie脚本对Make工具的版本没有要求。  

2. Modelsim  
与iverilog相比，Modelsim更为笨重和高效。若需要更长的仿真时间(大于600000ns)或复杂的功能，Modelsim更适合。  
Modelsim仿真的TCL脚本实测兼容`Modelsim 2019.2`版本，其他版本不提供支持。  

3. GCC交叉编译器  
BSP借助了MRS的集成开发环境，一条龙服务。不推荐使用Makefile+GCC交叉编译器完成软件编译工作，也不会继续维护`bsp/app/`下的makefile脚本。  

### 安装指导
#### Windows
1. iverilog  
参考[安装iverilog仿真环境](/doc/使用手册/安装iverilog仿真环境.md)  

2. Python
#### Linux
1. iverilog  
参考[安装iverilog仿真环境](/doc/使用手册/安装iverilog仿真环境.md)  
## 软硬件联合仿真
### 操作流程
### 原理

## FPGA实现
### 操作流程
### 原理




## 仿真
本工程使用`批处理/Makefile + Python3 + Modelsim/iverilog`可根据个人喜好与平台使用合适的工具完成仿真全流程。如果已配置相关工具，可跳过环境搭建步骤。    
若需要编写c语言程序并仿真，请参阅[板级支持包BSP](#板级支持包bsp)  
**仿真环境框架**  
![soc架构](/doc/图库/Readme/仿真环境.svg)  

### Linux环境搭建与仿真
必须使用带有图形化界面的Linux的系统，否则无法正常仿真。    
Linux下仅支持iverilog  
Debian系(Ubuntu、Debian、Deepin)执行以下命令：  
```
sudo apt install make git python3 python3-tk gtkwave gcc g++ bison flex gperf autoconf
git clone -b v12_0 --depth=1 https://gitee.com/xiaowuzxc/iverilog/
cd iverilog
sh autoconf.sh
./configure
make
sudo make install
cd ..
rm -rf iverilog/
```
其他Linux发行版暂不提供支持，请自行探索。  

- `/tb/makefile`是Linux环境下的实现各项仿真功能的启动器  

进入`/tb/`目录，终端输入`make`即可启动人机交互界面。根据提示，输入`make`+`空格`+`单个数字或符号`，按下回车即可执行对应项目。   

Makefile支持以下命令：  
- [0]导入inst.txt，RTL仿真并显示波形  
- [1]收集指令测试集程序，测试所有指令  
- [2]转换bin文件为inst.txt，可被testbench读取  
- [3]转换bin文件并进行RTL仿真、显示波形，主要用于仿真c语言程序  
- [4]显示上一次的仿真波形  
- [c]清理缓存文件  

### Windows环境搭建
- 进入[Python官网](https://www.python.org/)，下载并安装Python 3.x版本(建议使用稳定版)  
- (可跳过)如果想在Win系统使用make，请参阅[Makefile开发](#Makefile开发)第2步。  
#### iverilog仿真
进入[iverilog Win发行版](http://bleyer.org/icarus/)，下载并安装iverilog-v12-20220611-x64_setup[18.2MB]  
Windows下iverilog安装流程及仿真可参考[视频教程](https://www.bilibili.com/video/bv1dS4y1H7zn)  
**可选择以下任意一种方式进行仿真**  
- `/tb/run_zh.bat`是Windows环境下的启动器，进入`/tb/`目录，仅需双击`run_zh.bat`即可启动人机交互界面。根据提示，输入单个数字或符号，按下回车即可执行对应项目。  
- `/tb/makefile`是Windows/Linux环境下的启动器，进入`/tb/`目录，终端输入`make`即可启动人机交互界面。根据提示，输入`make`+`空格`+`单个数字或符号`，按下回车即可执行对应项目。   

处理器运行C语言程序，见[板级支持包BSP](#板级支持包bsp)。需要将生成的`obj.bin`转换为`inst.txt`文件，才能导入程序并执行仿真。命令2仅转换，命令3可以转换并仿真。  

`/tb/tools/tools.py`是仿真脚本的核心，负责控制仿真流程，转换文件类型，数据收集。使用者通过启动器与此脚本交互，一般情况下不建议修改。  
iverilog是仿真工具，gtkwave用于查看波形。  


#### Modelsim仿真
仅限Windows系统  
本工程提供了Modelsim仿真脚本，启动方式与iverilog类似，软件安装问题请各显神通  
- `/tb/run_zh.bat`是Windows环境下的启动器，进入`/tb/`目录，仅需双击`run_zh.bat`即可启动人机交互界面。根据提示，输入单个数字或符号，按下回车即可执行对应项目。   
- 处理器运行C语言程序，见[板级支持包BSP](#板级支持包bsp)。需要将生成的`obj.bin`转换为`inst.txt`文件(命令2转换，命令3可以直接转换并仿真)，才能导入程序并执行仿真。  
- `/tb/tools/vsim_xxx.tcl`主导Modelsim的启动、配置、编译、仿真流程，由批处理脚本启动，Modelsim启动后读入。  

  

### 问题说明
- inst.txt是被testbench读入指令存储器的文件，必须存在此文件处理器才可运行  
- 程序编译生成的bin文件不能直接被读取，需要先转换为inst.txt  
- iverilog版本建议大于v11，低于此版本可能会无法运行  
- Makefile环境下可能会出现gtkwave开着的情况下不显示打印信息  
- Windows下`make`建议使用Powershell，经测试Bash存在未知bug(实验性修复)   
- (已修复)~~run_zh.bat是中文的启动器，但是由于`git CRLF`相关问题无法使用~~  
- 若出现`WARNING: tb_soc.sv:23: $readmemh(inst.txt):...`或`ERROR: tb_soc.sv:24: $readmemh:`警告或错误信息，请忽略，它不会有任何影响  
- 本项目基于Modelsim SE 2019.2进行环境搭建，此版本保证脚本的有效性；10.6d版本存在问题  



## 板级支持包BSP
位于`/bsp/`文件夹下   
本工程使用MRS(MounRiver Studio)作为图形化集成开发环境。MRS基于Eclipse开发，支持中文界面和帮助信息，配置了完善的GCC工具链，可以做到开箱即用。  
官网链接http://www.mounriver.com/  
使用流程：  
1. 下载并安装MRS  
2. 切换中文界面。打开MRS主界面，`Help`->`Language`->`Simplified Chinese`  
3. 双击打开`/bsp/SparrowRV.wvproj`
4. 点击`构建项目`，编译并生成bin文件





## 1.环境准备
参考[搭建开发环境](/doc/使用手册/搭建开发环境.md)，其中iverilog不是必需的  

## 2.编译软件
打开`bsp/SparrowRV.wvproj`，启动MRS并进入工作空间  
打开`bsp/lib/system.h`，把`#define CPU_FREQ_HZ   27000000UL`修改为你在FPGA上的工作频率  
打开`bsp/lib/system.h`，把`#define sim_csr_printf 1`注释掉，即`//#define sim_csr_printf 1`  
点击左上角编译  

## 3.转化二进制文件
编译后在`bsp/obj/`文件夹生成`SparrowRV.bin`文件，需要将它转为文本文件才能被HDL仿真器或FPGA综合器读入  
打开`tb/run_zh.bat`，输入数字`2`并回车，出现文件选择界面  
找到`bsp/obj/SparrowRV.bin`文件并打开，会生成`tb/inst.txt`  

## 调整RTL配置
小麻雀处理器的RTL设计`rtl/`包含了`源文件.v`和`头文件.v`，头文件只有此目录下的`config.v`和`define.v`，`config.v`是需要使用者修改的  
为了保证最佳的兼容性需要做以下设置：  
|宏定义|配置|
|-|-|
|CPU_CLOCK_HZ|处理器在FPGA上的主频|
|SRAM_MODEL|"DP_ROM"|
|PROG_IN_FPGA|打开宏定义，综合阶段导入程序|
|PROG_FPGA_PATH|设置为inst.txt的路径，斜杠方向必须为/|

## 逻辑综合
这里涉及具体的FPGA平台，我默认你会FPGA开发流程，在此只能提供一些注意事项  
`rtl/`目录下所有文件都必须添加  
`config.v`和`define.v`是头文件，需要加入`include path`，具体操作方式由软件决定  
建议做时钟约束，模板如下  
```
create_clock -period 40.000 -name clk [get_ports clk] #约束主时钟
create_clock -period 100.000 -name jtag_clk [get_ports JTAG_TCK] #约束JTAG时钟
set_clock_groups -asynchronous -group [get_clocks clk] -group [get_clocks {jtag_clk}] #异步时钟组
```
IO约束/引脚分配，根据自己的板子来决定。其中`fpioa[1]`是默认的printf串口打印端口，对应外设UART0的Tx，需要连接串口芯片的UART Rx引脚  

### 示例工程
`fpga/gowin`提供了`Sipeed Tang nano 20k`开发板的示例工程，对应高云GW2AR-LV18 FPGA器件  
`fpga/anlogic`提供了`SparkRoad`开发板的示例工程，对应安路EG4S20 FPGA器件  

## HelloWorld
连接并打开你的串口，波特率115200，停止位1，无校验位  
上电、烧录  
看Helloworld！  
